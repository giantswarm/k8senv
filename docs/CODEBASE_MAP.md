---
last_mapped: 2026-02-16T12:00:00Z
total_files: 147
total_tokens: 358550
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-02-16

## System Overview

k8senv is a lightweight Kubernetes testing framework that manages on-demand kube-apiserver instances backed by kine (SQLite-based etcd shim) for efficient parallel test execution. Instances are created lazily, pooled for reuse, and isolated through namespaces.

```mermaid
graph TB
    subgraph "Public API (root package)"
        Factory["NewManager() — singleton via sync.Once"]
        MI[Manager Interface]
        II[Instance Interface]
        Opts[Functional Options]
    end

    subgraph "Internal Core"
        Mgr["core.Manager — state machine (atomics)"]
        Pool["core.Pool — bounded LIFO (default 4)"]
        Inst["core.Instance — gen counter + startMu"]
    end

    subgraph "Process Stack"
        Stack[kubestack.Stack]
        Kine[kine.Process]
        API[apiserver.Process]
    end

    subgraph "Infrastructure"
        Proc[process.BaseProcess]
        Net["netutil.PortRegistry"]
        File[fileutil]
        CRD[crdcache]
        Sentinel[sentinel.Error]
    end

    subgraph "External Processes"
        KineBin["kine binary (SQLite)"]
        APIBin["kube-apiserver binary"]
    end

    Factory --> Mgr
    MI --> Mgr
    II --> Inst
    Opts --> Mgr

    Mgr --> Pool
    Pool --> Inst
    Inst --> Stack

    Stack --> Kine
    Stack --> API
    Stack --> Net

    Kine --> Proc
    API --> Proc
    Kine --> File
    API --> File

    Kine --> KineBin
    API --> APIBin

    Mgr --> CRD
    CRD --> Stack
    CRD --> File
```

## Directory Structure

```
k8senv/
├── doc.go                     # Package documentation with usage examples
├── interfaces.go              # Manager and Instance public interfaces
├── k8senv.go                  # NewManager() singleton factory + adapter wrappers
├── options.go                 # Functional options (WithCRDDir, WithAcquireTimeout, etc.)
├── defaults.go                # Exported default constants (timeouts, binary names)
├── errors.go                  # Sentinel error re-exports from internal/core
├── config.go                  # Unexported managerConfig + conversion to core
├── log.go                     # SetLogger() public API
├── tests/                     # Integration tests (package k8senv_test)
│   ├── main_test.go           # TestMain: singleton manager + binary validation
│   ├── helpers_test.go        # Shared helpers: uniqueNS, panic utils
│   ├── instance_test.go       # Instance lifecycle, API-only mode, port retry
│   ├── pool_test.go           # Pool acquire/release, concurrent access
│   ├── lifecycle_test.go      # Initialize idempotent/concurrent
│   ├── options_test.go        # Option validation panics
│   ├── coverage_test.go       # Coverage expansion: logger, context cancel, defaults
│   ├── cleanup_test.go        # Namespace cleanup on release, system namespace preservation
│   └── stress_test.go         # High-volume parallel stress with random resources
├── tests/crd/                 # CRD tests (separate package k8senv_crd_test)
│   ├── main_test.go           # TestMain: singleton manager with WithCRDDir
│   ├── helpers_test.go        # CRD-specific helpers + verifyCRDExists
│   └── crd_test.go            # CRD caching, multi-doc YAML, .yml extension
├── tests/poolsize/            # Pool size tests (separate package k8senv_poolsize_test)
│   ├── main_test.go           # TestMain: singleton with WithPoolSize(2)
│   └── poolsize_test.go       # Pool exhaustion, timeout, release-unblocks
├── tests/internal/testutil/
│   └── testutil.go            # Shared test helpers: UniqueNS, AcquireWithClient, RunTestMain
├── internal/
│   ├── core/                  # Core orchestration layer
│   │   ├── config.go          # ManagerConfig + InstanceConfig with Validate()
│   │   ├── config_test.go     # Canary test: field count check
│   │   ├── manager.go         # Manager: state machine, two-phase init, parallel shutdown
│   │   ├── pool.go            # Pool: bounded LIFO (default 4), double-release detection
│   │   ├── instance.go        # Instance: gen counter, startMu, retry on port conflict
│   │   ├── cleanup.go         # Namespace cleanup: parallel deletion, finalizer removal
│   │   └── log.go             # Package logger: atomic pointers + CAS caching
│   ├── kubestack/
│   │   └── stack.go           # Orchestrates kine + apiserver with errgroup
│   ├── apiserver/
│   │   └── process.go         # kube-apiserver: ECDSA certs, AlwaysAllow, /livez
│   ├── kine/
│   │   └── process.go         # kine: SQLite backend, optional DB prepopulation
│   ├── process/               # Process abstraction layer
│   │   ├── base.go            # BaseProcess: lifecycle, Wait goroutine, exited channel
│   │   ├── process.go         # SIGTERM → SIGKILL stop, LogFiles management
│   │   ├── stoppable.go       # Stoppable interface + generic StopCloseAndNil
│   │   ├── wait.go            # WaitReady: polling + ProcessExited fast abort
│   │   └── wait_test.go       # WaitReady unit tests
│   ├── crdcache/              # CRD cache system
│   │   ├── cache.go           # Content-addressable DB cache (EnsureCache)
│   │   ├── apply.go           # Dynamic YAML application via unstructured client
│   │   ├── apply_test.go      # Apply unit tests
│   │   ├── hash.go            # Deterministic SHA256 directory hashing
│   │   ├── hash_test.go       # Hash unit tests
│   │   ├── lock.go            # File-based locking (gofrs/flock)
│   │   └── walk.go            # Recursive YAML file discovery
│   ├── netutil/
│   │   ├── port.go            # PortRegistry: AllocatePortPair + reserve
│   │   └── port_test.go       # Port allocation tests
│   ├── fileutil/
│   │   ├── copy.go            # Atomic file copy with fsync
│   │   ├── copy_test.go       # Copy unit tests
│   │   ├── dir.go             # EnsureDir, EnsureDirForFile
│   │   └── dir_test.go        # Dir unit tests
│   └── sentinel/
│       ├── sentinel.go        # sentinel.Error: const-compatible error type
│       └── sentinel_test.go   # Sentinel unit tests
├── crds/                      # 7 Cluster API CRDs (~1.1MB, for CRD tests)
├── docs/                      # User documentation (Diataxis framework)
│   ├── README.md              # Documentation index
│   ├── tutorials/
│   │   └── getting-started.md # Installation + first test walkthrough
│   ├── how-to/
│   │   ├── crd-testing.md     # CRD pre-loading with cache
│   │   └── parallel-testing.md # Concurrent test patterns
│   ├── reference/
│   │   ├── configuration.md   # Complete option reference
│   │   ├── data-flow.md       # Request lifecycle + state diagrams
│   │   ├── directory-structure.md # File reference with purposes
│   │   └── troubleshooting.md # Common issues + debug techniques
│   ├── explanation/
│   │   └── architecture-overview.md # Design principles + rationale
│   └── CODEBASE_MAP.md        # This file
├── specs/
│   └── prd.md                 # Product Requirements Document
├── scripts/
│   └── download-crds.sh       # Download CRDs from upstream projects
├── Makefile                   # Main entry point, includes Makefile.*.mk
├── Makefile.ci.mk             # CI targets (ci, ci-full, check, all)
├── Makefile.dev.mk            # Dev targets (build, fmt, lint, deps)
├── Makefile.test.mk           # Test targets (test-unit, test-integration, coverage, find-flaky)
├── Makefile.tools.mk          # Tool install targets (kine, kube-apiserver, golangci-lint)
├── .golangci.yml              # 55 enabled linters across 11 tiers
├── go.mod                     # Module: github.com/giantswarm/k8senv (Go 1.25.4)
└── go.sum
```

## Module Guide

### Public API (root package `k8senv`)

**Purpose**: Thin facade exposing interfaces, factory, options, and errors. All implementation delegated to `internal/core`.

**Entry point**: `k8senv.go` (`NewManager()` — process-level singleton via `sync.Once`)

| File | Purpose | Tokens |
|------|---------|--------|
| `interfaces.go` | `Manager` and `Instance` interfaces | 802 |
| `k8senv.go` | `NewManager()` singleton factory + adapter wrappers | 1051 |
| `options.go` | 10 functional options with panic-on-invalid validation | 1316 |
| `defaults.go` | Exported default constants (timeouts, binary names) | 425 |
| `errors.go` | 7 sentinel errors re-exported from `internal/core` | 297 |
| `config.go` | Unexported `managerConfig` + conversion to `core.ManagerConfig` | 103 |
| `log.go` | `SetLogger()` for custom logging | 194 |
| `doc.go` | Package documentation with examples | 457 |

**Key exports**:
```go
// Interfaces
type Manager interface { Initialize(ctx) error; Acquire(ctx) (Instance, error); Shutdown() error }
type Instance interface { Config() (*rest.Config, error); Release(clean bool) error; ID() string }

// Factory (singleton — first call creates, subsequent calls return same instance)
func NewManager(opts ...ManagerOption) Manager

// Options (all panic on invalid input)
func WithPoolSize(int) ManagerOption
func WithKineBinary(string) ManagerOption
func WithKubeAPIServerBinary(string) ManagerOption
func WithAcquireTimeout(time.Duration) ManagerOption
func WithPrepopulateDB(string) ManagerOption
func WithCRDDir(string) ManagerOption
func WithBaseDataDir(string) ManagerOption
func WithCRDCacheTimeout(time.Duration) ManagerOption
func WithInstanceStartTimeout(time.Duration) ManagerOption
func WithInstanceStopTimeout(time.Duration) ManagerOption

// Errors (sentinel.Error — compatible with errors.Is)
var ErrShuttingDown, ErrNotInitialized, ErrPoolClosed, ErrInstanceReleased,
    ErrNotStarted, ErrNoYAMLFiles, ErrMissingKind error

// Logging
func SetLogger(*slog.Logger)
```

**Pattern**: Adapter pattern wraps `internal/core` types into public interfaces via unexported `managerWrapper`/`instanceWrapper`. Named unexported fields prevent type assertion escape hatch.

---

### internal/core — Core Orchestration

**Purpose**: Implements Manager, Pool, and Instance with atomic state, lazy initialization, and on-demand instance creation.

| File | Purpose | Tokens |
|------|---------|--------|
| `manager.go` | State machine (atomic), two-phase init, parallel shutdown, inflight drain | 4767 |
| `pool.go` | Bounded LIFO pool (default 4), semaphore, double-release detection | 2146 |
| `instance.go` | Instance lifecycle: generation counter (atomic), startMu, retry on port conflict | 4594 |
| `cleanup.go` | Namespace cleanup: parallel deletion (limit 10), finalizer removal, confirmations | 2253 |
| `config.go` | `ManagerConfig` and `InstanceConfig` with `Validate()` (errors.Join) | 1383 |
| `config_test.go` | Canary test: reflection-based field count check | 1863 |
| `log.go` | Package logger: dual atomic pointers + CAS caching | 633 |

**Key interactions**:
- `Manager` uses atomic state machine: `created -> initializing -> ready -> shuttingDown`
- `Pool` creates instances on demand via factory; LIFO stack for cache locality
- `Instance` uses generation counter (atomic uint64, odd=acquired/even=free) with `startMu` serializing Start/Stop
- `cleanup.go` handles namespace cleanup with parallel deletion, finalizer removal (no controller-manager), and confirmation polling

**Concurrency model**:
- `state atomic.Uint32` — Fast state checks in Manager
- `pool atomic.Pointer[Pool]` — Lock-free pool reads on Acquire hot path
- `inflight atomic.Int64` + `inflightDone chan` — Drain pattern for shutdown vs in-flight releases
- `initMu sync.Mutex` — Serializes concurrent Initialize calls only
- `gen atomic.Uint64` — Generation counter for ABA prevention on double-release
- `started atomic.Bool` — Lock-free Instance state
- Lock independence: `inflight` is atomic (not a lock); `initMu` is used only during Initialize

---

### internal/kubestack — Process Stack

**Purpose**: Orchestrates coordinated kine + kube-apiserver startup/shutdown as a single unit.

| File | Purpose | Tokens |
|------|---------|--------|
| `stack.go` | Two-process lifecycle with errgroup, two-context pattern, retry on port conflict | 3480 |

**Startup**: `errgroup.WithContext` starts kine and apiserver in parallel. Kine waits for TCP readiness, apiserver waits for `/livez`. Two-context pattern: `processCtx` (Background) for process lifetime, `readyCtx` (caller) for startup timeout.

**Shutdown**: Reverse order (apiserver first, then kine). Each process gets full timeout (not shared). Uses `errors.Join` for multiple failures.

**Port allocation**: Delegates to `PortRegistry.AllocatePortPair()` for two distinct ports. `StartWithRetry` creates fresh Stack on port conflicts.

---

### internal/apiserver — kube-apiserver Process

**Purpose**: Manages kube-apiserver with self-signed certs, AlwaysAllow auth, and health monitoring.

| File | Purpose | Tokens |
|------|---------|--------|
| `process.go` | ECDSA P-256 certs, AlwaysAllow authz, parallel file prep, `/livez` health check | 3322 |

**Key decisions**: ECDSA P-256 (<1ms vs RSA 2048 ~50-200ms). `AlwaysAllow` authorization (skips RBAC startup, ~6s saved). `/livez` instead of `/readyz` (skips slow post-start hooks, ~6-7s saved). `--watch-cache=false` for immediate consistency. Anonymous health endpoints via `AuthenticationConfiguration`. `DisableKeepAlives` in HTTP client prevents connection accumulation.

**Parallel file prep**: Token file, certificates, and auth config generated concurrently via errgroup.

---

### internal/kine — kine Process

**Purpose**: Manages kine (etcd-compatible SQLite shim) process.

| File | Purpose | Tokens |
|------|---------|--------|
| `process.go` | SQLite backend, optional DB prepopulation, TCP readiness probe | 1270 |

**Key behavior**: Copies cached DB at construction time (not startup). Disables metrics server (`--metrics-bind-address=0`) to avoid port conflicts. Readiness check via TCP dial (no HTTP endpoint).

---

### internal/process — Process Abstraction

**Purpose**: Generic process lifecycle management with composition-based reuse.

| File | Purpose | Tokens |
|------|---------|--------|
| `base.go` | `BaseProcess`: lifecycle, single Wait goroutine, exited broadcast channel | 1272 |
| `process.go` | SIGTERM -> SIGKILL stop (5s grace), LogFiles management | 1694 |
| `stoppable.go` | `Stoppable` interface + generic `StopCloseAndNil[P, E]` | 421 |
| `wait.go` | `WaitReady`: polling with `ProcessExited` channel for fast abort | 613 |
| `wait_test.go` | WaitReady unit tests | 997 |

**Layer hierarchy**:
```
Stoppable interface
    ^
BaseProcess (embeddable)
    ^
├── kine.Process
└── apiserver.Process
```

**Process death detection**: `WaitReady` accepts `ProcessExited <-chan struct{}` — checked before each readiness attempt for fast abort if process dies during startup.

**Stop sequence**: SIGTERM -> 5s grace (capped at total timeout) -> SIGKILL -> 10s hard drain on Wait channel. `SysProcAttr.Pdeathsig = SIGTERM` ensures child dies if parent dies.

---

### internal/crdcache — CRD Cache System

**Purpose**: Content-addressable caching of CRD-populated SQLite databases for fast instance startup.

| File | Purpose | Tokens |
|------|---------|--------|
| `cache.go` | `EnsureCache`: double-checked locking, temp stack, sync.Once stop | 3610 |
| `apply.go` | Dynamic YAML application: multi-doc, discovery retry (5 attempts, 100ms backoff) | 2779 |
| `apply_test.go` | Apply unit tests | 1523 |
| `hash.go` | Deterministic SHA256 hash (first 16 hex chars) of sorted YAML files | 472 |
| `hash_test.go` | Hash unit tests | 2047 |
| `lock.go` | File-based locking via `gofrs/flock` (50ms retry interval) | 473 |
| `walk.go` | Recursive sorted YAML file discovery (.yaml/.yml) | 193 |

**Cache flow**: `computeDirHash(crdDir)` -> check `cached-{hash}.db` -> if miss: acquire file lock -> re-check (double-checked locking) -> spin up temp kubestack -> apply CRDs -> wait for Established condition -> stop stack (flush writes) -> copy DB -> release lock.

**CRD apply**: Uses dynamic client with unstructured resources. Discovery retry with backoff for CRD registration propagation. Non-caching discovery client required for fresh API requests. `maxYAMLFiles=1000` guards against misconfiguration.

---

### internal/netutil — Network Utilities

| File | Purpose | Tokens |
|------|---------|--------|
| `port.go` | `PortRegistry`: `AllocatePortPair()`, reserve/release tracking | 1094 |
| `port_test.go` | Port allocation tests | 1883 |

**Port allocation**: Both listeners held open simultaneously (guarantees distinct ports). Registry tracks in-use ports to prevent TOCTOU. Retry on duplicate (maxPortRetries=20). Must release ports manually; no finalizer cleanup.

---

### internal/fileutil — File Utilities

| File | Purpose | Tokens |
|------|---------|--------|
| `copy.go` | `CopyFile` with atomic write (temp + rename), optional fsync | 1077 |
| `copy_test.go` | Copy unit tests | 2124 |
| `dir.go` | `EnsureDir`, `EnsureDirForFile` (idempotent mkdir) | 175 |
| `dir_test.go` | Dir unit tests | 771 |

---

### internal/sentinel — Sentinel Errors

| File | Purpose | Tokens |
|------|---------|--------|
| `sentinel.go` | `sentinel.Error` string type: const-compatible, `errors.Is` compatible | 119 |
| `sentinel_test.go` | Sentinel unit tests | 550 |

---

### Tests

**Three test packages** with distinct singleton managers:

**`tests/` (package `k8senv_test`)** — Core integration tests (build tag: `integration`):

| File | Tests | Purpose |
|------|-------|---------|
| `main_test.go` | -- | TestMain: singleton manager, dynamic pool size, binary validation |
| `helpers_test.go` | -- | uniqueNS (atomic), acquireWithClient, panic helpers |
| `instance_test.go` | 7 | BasicUsage, Reuse, IDUniqueness, DoubleRelease, APIOnly, MultiInstance, PortRetry |
| `pool_test.go` | 3 | AcquireRelease, ConcurrentAccess, ParallelAcquisition (10 goroutines) |
| `lifecycle_test.go` | 2 | InitializeIdempotent, InitializeConcurrent |
| `options_test.go` | 4 | AcquireTimeout, KineBinary, PoolSize, KubeAPIServerBinary panic validation |
| `coverage_test.go` | 7 | ListNamespaces, Logger, EmptyStrings, ContextCancel, UsableInstance, CustomLogger, Shutdown |
| `cleanup_test.go` | 4 | SystemNamespacesMatch, CleanupNamespaces, PreserveSystemNS, NoUserNamespaces fast path |
| `stress_test.go` | 1 | 100+ parallel subtests with random resource creation (ConfigMap, Secret, Service, Pod, SA) |

**`tests/crd/` (package `k8senv_crd_test`)** — CRD tests with `WithCRDDir` singleton:

| File | Tests | Purpose |
|------|-------|---------|
| `main_test.go` | -- | TestMain: singleton with CRD directory, 5 sample CRDs |
| `helpers_test.go` | -- | CRD helpers + verifyCRDExists (apiextensions client) |
| `crd_test.go` | 5 | Caching, MultipleCRDs, CRAndInstance, MultiDocumentYAML, YmlExtension |

**`tests/poolsize/` (package `k8senv_poolsize_test`)** — Bounded pool tests with `WithPoolSize(2)`:

| File | Tests | Purpose |
|------|-------|---------|
| `main_test.go` | -- | TestMain: singleton with fixed pool size 2 |
| `poolsize_test.go` | 3 | PoolTimeout (exhaustion), ReleaseUnblocks, BoundedInstanceReuse |

**`tests/internal/testutil/`** — Shared helpers across all test packages:

| Function | Purpose |
|----------|---------|
| `UniqueNS(prefix)` | Atomic counter for unique namespace names |
| `TestParallel()` | Returns effective `-test.parallel` value |
| `AcquireWithClient(ctx, t, mgr)` | Acquires instance + creates k8s client |
| `SetupTestLogging()` | Configures slog from `K8SENV_LOG_LEVEL` |
| `RequireBinariesOrExit()` | Validates kine/kube-apiserver in PATH |
| `RunTestMain(m, mgr, tmpDir)` | Signal handling + cleanup lifecycle |

**Key patterns**: `t.Parallel()` everywhere (except logger tests and poolsize tests). Unique namespaces via atomic counter. Table-driven panic tests. Race detector compatible. Poolsize tests are sequential to control pool state precisely.

---

### Build & Configuration

| File | Purpose |
|------|---------|
| `Makefile` | Main entry, help system, includes `Makefile.*.mk` |
| `Makefile.ci.mk` | CI targets: `ci` (fast, no binaries), `ci-full` (requires binaries) |
| `Makefile.dev.mk` | Dev targets: `build`, `fmt`, `lint`, `lint-fix`, `deps` |
| `Makefile.test.mk` | Test targets: `test-unit`, `test-integration`, `coverage`, `find-flaky`, `find-all-flaky` |
| `Makefile.tools.mk` | Tool installs: kine, kube-apiserver, golangci-lint, pkgsite; `docs` server |
| `go.mod` | `github.com/giantswarm/k8senv`, Go 1.25.4, K8s client-go v0.35.0 |
| `.golangci.yml` | 55 linters across 11 tiers (static analysis, security, style, complexity) |

**Test options** (override on command line):
- `RACE=1` — Enable race detector
- `NOCACHE=1` — Disable test cache
- `TEST=TestName` — Run specific test
- `LOG_LEVEL=DEBUG` — Set log verbosity
- `PARALLEL=N` — Parallel test count (default: 8)
- `STRESS_SUBTESTS=N` — Override stress subtest count

**Direct dependencies**: `gofrs/flock`, `k8s.io/api`, `k8s.io/apiextensions-apiserver`, `k8s.io/apimachinery`, `k8s.io/client-go` (all v0.35.0), `golang.org/x/sync/errgroup`.

---

### Documentation (Diataxis Framework)

| Category | File | Purpose |
|----------|------|---------|
| Tutorial | `tutorials/getting-started.md` | Installation + first test walkthrough |
| How-To | `how-to/parallel-testing.md` | Concurrent test patterns with namespace isolation |
| How-To | `how-to/crd-testing.md` | CRD pre-loading with hash-based cache |
| Reference | `reference/configuration.md` | Complete option reference with defaults |
| Reference | `reference/data-flow.md` | Request lifecycle + state machine diagrams |
| Reference | `reference/directory-structure.md` | File reference with purposes |
| Reference | `reference/troubleshooting.md` | Common issues + debug techniques |
| Explanation | `explanation/architecture-overview.md` | Design principles + technology rationale |

---

## Data Flow

### Test Lifecycle

```mermaid
sequenceDiagram
    participant Test
    participant Manager
    participant Pool
    participant Instance
    participant Stack
    participant Kine
    participant APIServer

    Test->>Manager: NewManager(opts...) [singleton]
    Test->>Manager: Initialize(ctx) [idempotent]
    Test->>Manager: Acquire(ctx)
    Manager->>Pool: Acquire(ctx)

    alt No idle instance
        Pool->>Pool: factory() — create new
    else Idle instance available
        Pool->>Pool: Pop from LIFO stack
    end

    Pool-->>Manager: Instance + token

    alt Not yet started
        Manager->>Instance: Start(ctx)
        Instance->>Stack: New(cfg)
        Stack->>Stack: PortRegistry.AllocatePortPair()
        par Start in parallel
            Stack->>Kine: Start(processCtx)
            Kine->>Kine: TCP probe until ready
        and
            Stack->>APIServer: Start(processCtx)
            APIServer->>APIServer: /livez probe until ready
        end
        Stack-->>Instance: Ready
    end

    Manager-->>Test: Instance

    Test->>Instance: Config()
    Instance-->>Test: *rest.Config
    Note over Test: Use Kubernetes client

    Test->>Instance: Release(false)
    Instance->>Instance: Clean non-system namespaces
    Instance->>Pool: Return to LIFO stack

    Test->>Manager: Shutdown()
    Manager->>Manager: state -> shuttingDown
    Manager->>Manager: Wait inflightDone (30s)
    par Stop all instances
        Manager->>Instance: Stop(timeout)
        Instance->>Stack: Stop (apiserver first, then kine)
    end
```

### CRD Cache Creation

```mermaid
sequenceDiagram
    participant Manager
    participant CRDCache
    participant Lock
    participant Stack
    participant APIServer

    Manager->>CRDCache: EnsureCache(ctx, cfg)
    CRDCache->>CRDCache: computeDirHash(crdDir) — SHA256
    CRDCache->>CRDCache: Check cached-{hash}.db exists?

    alt Cache hit
        CRDCache-->>Manager: Result{CachePath, Hash}
    else Cache miss
        CRDCache->>Lock: acquireFileLock(ctx, 50ms retry)
        CRDCache->>CRDCache: Re-check (double-checked locking)
        CRDCache->>Stack: Start temp kubestack
        CRDCache->>APIServer: applyYAMLFiles(crdDir)
        Note over APIServer: Multi-doc YAML, discovery retry (5x 100ms)
        CRDCache->>CRDCache: waitForCRDsEstablished()
        CRDCache->>Stack: Stop (sync.Once — flush writes)
        CRDCache->>CRDCache: CopyFile(db, cached-{hash}.db)
        CRDCache->>Lock: releaseFileLock()
        CRDCache-->>Manager: Result{CachePath, Hash}
    end
```

### Pool State Machine

```mermaid
stateDiagram-v2
    [*] --> Idle: factory() creates instance
    Idle --> Busy: Pool.Acquire() — pop LIFO
    Busy --> Idle: Release(false) — push LIFO
    Busy --> Stopped: Release(true)
    Busy --> Failed: ReleaseFailed()
    Stopped --> [*]
    Failed --> [*]
```

## Conventions

**Naming**:
- Interfaces in root package, implementations in `internal/`
- Functional options: `With[Setting](value) ManagerOption` (panic on invalid)
- Sentinel errors: `Err[Condition]` (e.g., `ErrShuttingDown`) — `const` via `sentinel.Error`
- Process types: `[Name].Process` with embedded `BaseProcess`
- Instance IDs: `inst-{index}-{8-hex-chars}`

**Concurrency**:
- Prefer atomics for fast reads (`gen`, `started`, `state`)
- Mutex only for complex state (Pool, PortRegistry)
- Generation counter (atomic uint64) for ABA prevention on double-release
- Atomic counters for TOCTOU guards (inflight)
- `sync.Once` for singletons (Manager, PortRegistry, logger cache)
- `errgroup.WithContext` for parallel operations

**Error handling**:
- Sentinel errors for caller-facing conditions (`errors.Is()` compatible)
- `fmt.Errorf("context: %w", err)` wrapping throughout
- `errors.Join()` for collecting multiple errors (validation, shutdown)
- Panics only for programmer errors (invalid options, double-release, nil factory)

**Testing**:
- All tests are integration tests (`//go:build integration`)
- External package pattern (`k8senv_test`) — only public API tested
- Tests fail (not skip) if binaries missing
- `t.Parallel()` for concurrent tests, `t.Cleanup()` for deferred teardown
- Three test packages with separate singletons (core, CRD, poolsize)

**Logging**:
- `log/slog` throughout (structured logging)
- Package logger with `"component": "k8senv"` attribute
- Instance loggers add `"id": instanceID`
- Atomic pointer + CAS for lock-free logger access
- `K8SENV_LOG_LEVEL` env var for test verbosity

**Lint**:
- 55 linters enabled in `.golangci.yml` across 11 tiers
- Cyclomatic complexity: 15, Cognitive complexity: 20
- `//nolint:linter // justification` required for suppressions
- Test files exclude: gocyclo, gocognit, dupl, goconst, unparam, forcetypeassert

## Gotchas

1. **Manager is a process-level singleton** — `NewManager()` uses `sync.Once`. Options are ignored after the first call (logs warning). Cannot be reset without process restart.

2. **AcquireTimeout covers pool wait + instance startup** — with a bounded pool (default: 4), Acquire may block waiting for a free instance before creating or reusing one. The timeout covers both wait time and startup (~5-15s). Default 30s is sufficient for most cases; increase if pool contention is expected.

3. **Lazy initialization** — first `Acquire()` on each instance pays startup cost. Subsequent acquires of a reused instance are instant (if `Release(false)` was used).

4. **Release(false) vs Release(true)** — `false` keeps processes running for reuse (cleans namespaces, returns nil on success). `true` stops processes for clean state. Always prefer `false` unless you need fresh state.

5. **Generation counter prevents double-release** — calling `Release()` twice with the same token triggers a panic (programmer error). The generation counter (odd=acquired, even=free) provides ABA prevention.

6. **Config() has TOCTOU window** — the generation check in `Config()` is a defensive guard, not a concurrency guarantee. Documented as intentional (caller error if racing with Release).

7. **Port allocation TOCTOU** — ports from kernel may be claimed before use. Mitigated by PortRegistry (prevents internal conflicts) and `StartWithRetry` (creates fresh Stack on port conflict, up to 5 retries).

8. **Two-context pattern in Stack** — `processCtx` (Background) keeps processes alive across test boundaries; `readyCtx` (caller) only gates startup timeout.

9. **API-only mode** — no scheduler or controller-manager. Pods remain Pending. Controllers don't reconcile. Finalizers must be removed manually during cleanup.

10. **Cached logger doesn't track slog.SetDefault()** — the cached default logger is set once via CAS. Call `SetLogger(nil)` to force a refresh.

11. **CRD cache first run** — spins up a temporary kubestack, applies CRDs, waits for Established condition, copies the DB. Can take 30+ seconds. Subsequent runs use cached DB instantly.

12. **Lock independence** — Manager: `inflight` is atomic (not a lock); `initMu` is used only during Initialize. Pool reads use `atomic.Pointer`, removing lock-ordering constraints.

13. **Stop timeout is per-process** — Stack stops apiserver then kine sequentially. Worst-case total = 2 * timeout.

14. **CRD apply discovery retry** — `missingKindErr` detection uses string matching because upstream `NoKindMatchError` doesn't implement `Unwrap`.

15. **Namespace cleanup requires finalizer removal** — API-only mode has no controller-manager, so namespace finalizers must be removed via Finalize subresource before deletion completes.

## Navigation Guide

**To add a new functional option**: Edit `options.go` — add a `With[Name]` function. Wire through `config.go` (root), `internal/core/config.go` (core), and `k8senv.go` (defaults). Update `config_test.go` field count canary.

**To add a new process type**: Create `internal/[name]/process.go`, embed `process.BaseProcess`, implement `Start(ctx)` and readiness check. Wire into `kubestack/stack.go` for coordinated lifecycle.

**To modify instance startup**: Edit `internal/core/instance.go` (`Start` method) and `internal/kubestack/stack.go` (`Start` method).

**To change pool behavior**: Edit `internal/core/pool.go` — `Acquire`, `Release`, or `ReleaseFailed` methods.

**To add an integration test**: Add to appropriate file in `tests/` with `//go:build integration` tag. Use `sharedManager.Acquire()`, `uniqueNS()`, `t.Parallel()`.

**To add a CRD test**: Add to `tests/crd/crd_test.go`. Define CRD YAML constant, add file creation in `main_test.go:setupSharedCRDDir()`.

**To add a pool exhaustion test**: Add to `tests/poolsize/poolsize_test.go`. Do NOT use `t.Parallel()` — these tests need exclusive pool access.

**To modify CRD caching**: Edit files in `internal/crdcache/` — `cache.go` for flow, `apply.go` for resource application, `hash.go` for cache key.

**To change kube-apiserver flags**: Edit `internal/apiserver/process.go` — modify `exec.Command` args in `Start()`.

**To change kine flags**: Edit `internal/kine/process.go` — modify `exec.Command` args in `Start()`.

**To add a linter**: Edit `.golangci.yml` — add to appropriate tier in `enable` list, configure in `settings`, add exclusions if needed.
